---
- name: Create a K8S master node with a new control plane
  hosts: first-master-node
  become: true
  tasks:
    - name: Provision first master node
      ansible.builtin.script: ./provision.sh create_first
      args:
        executable: /usr/bin/bash
    - name: Enable ExtendedResourceToleration in kube-apiserver
      ansible.builtin.replace:
        path: /etc/kubernetes/manifests
        regexp: ^(\s*- --enable-admission-plugins=.*$)(?<!,ExtendedResourceToleration)
        replace: \1,ExtendedResourceToleration
    - name: Set certificate rotation
      lineinfile: 
        path: /var/lib/kubelet/config.yaml
        regexp: 'rotateCertificates: (true|false)' 
        line: 'rotateCertificates: {{ rotateCertificates }}'
        backrefs: yes
